<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Supabase Login with MFA</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    #mfa-setup, #welcome, #loading, #logout { display: none; }
  </style>
</head>
<body>

  <h2>Supabase Login / Signup</h2>

  <div id="auth">
    <input type="email" id="email" placeholder="Email" />
    <br><br>
    <input type="password" id="password" placeholder="Password" />
    <br><br>
    <button id="signup">Sign Up</button>
    <button id="login">Login</button>
  </div>

  <div id="loading">üîê Logging in...</div>

  <div id="mfa-setup">
    <h3>Set up 2FA (App Authenticator)</h3>
    <p>Scan the QR code below with your authenticator app</p>
    <img id="mfa-qr" src="" alt="QR Code" />
    <br><br>
    <input type="text" id="mfa-code" placeholder="Enter 6-digit code" />
    <button id="verify-mfa">Verify MFA</button>
  </div>

  <div id="welcome">
    <h3>üéâ You're logged in!</h3>
    <p id="user-email"></p>
  </div>

  <button id="logout">Logout</button>

  <script>
    const SUPABASE_URL = 'https://ryeywgwkkkcvdhsaajmx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5ZXl3Z3dra2tjdmRoc2Fham14Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMxMDQ4MzUsImV4cCI6MjA1ODY4MDgzNX0.zhS8BebNMJ50RjIJ6K8Zw9ML0xoJadMgtTVpmVkrfGs';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let mfaFactorId = null;

    // Check for redirect after email confirmation
    async function handleAuthRedirect() {
      try {
        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (error) {
          console.error('Error checking auth state:', error);
          return;
        }

        if (session) {
          document.getElementById("user-email").innerText = session.user.email;
          toggleUI("loading");
          await handleMFA();
        }
      } catch (err) {
        console.error('Auth redirect error:', err);
      }
    }

    document.getElementById("signup").addEventListener("click", async () => {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;

      // Basic validation
      if (!email || !email.includes('@')) {
        alert("Please enter a valid email address");
        return;
      }

      if (!password || password.length < 6) {
        alert("Password must be at least 6 characters long");
        return;
      }

      // Try signup directly - Supabase will handle duplicate emails
      const { data, error } = await supabase.auth.signUp({ 
        email, 
        password,
        options: {
          emailRedirectTo: 'https://kbh2019.github.io/supabaseAuthPage'
        }
      });

      console.log('Signup response:', { data, error }); // Debug log

      if (error) {
        console.error('Signup error:', error); // Debug log
        alert("‚ùå Sign up failed: " + error.message);
        return;
      }

      if (data?.user?.identities?.length === 0) {
        alert("This email is already registered. Please log in instead.");
        return;
      }

      alert("‚úÖ Check your email to confirm your sign-up.");
    });

    document.getElementById("login").addEventListener("click", async () => {
      console.log('Starting login process...');
      toggleUI("loading");
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        console.log('Login response:', { data, error });

        if (error) {
          console.error('Login error:', error);
          toggleUI("auth");
          return alert("‚ùå Login failed: " + error.message);
        }

        const user = data.user;
        console.log('Login successful, user:', user);
        document.getElementById("user-email").innerText = user.email;

        await handleMFA();
      } catch (err) {
        console.error('Login exception:', err);
        toggleUI("auth");
        return alert("‚ùå Login failed. Please try again.");
      }
    });

    document.getElementById("verify-mfa").addEventListener("click", async () => {
      if (!mfaFactorId) {
        toggleUI("auth");
        return alert("‚ùå No MFA setup active. Please log in again.");
      }

      const code = document.getElementById("mfa-code").value;
      
      try {
        // First challenge the MFA
        const { data: challengeData, error: challengeError } = await supabase.auth.mfa.challenge({
          factorId: mfaFactorId
        });

        if (challengeError) {
          console.error('MFA challenge error:', challengeError);
          alert("‚ùå MFA challenge failed: " + challengeError.message);
          return;
        }

        // Then verify the code with the challenge
        const { error: verifyError } = await supabase.auth.mfa.verify({
          factorId: mfaFactorId,
          challengeId: challengeData.id,
          code
        });

        if (verifyError) {
          console.error('MFA verification error:', verifyError);
          alert("‚ùå Incorrect MFA code: " + verifyError.message);
          return;
        }

        toggleUI("welcome");
      } catch (err) {
        console.error('MFA verification exception:', err);
        alert("‚ùå MFA verification failed. Please try again.");
      }
    });

    document.getElementById("logout").addEventListener("click", async () => {
      await supabase.auth.signOut();
      alert("‚úÖ Logged out.");
      toggleUI("auth");
    });

    async function handleMFA() {
      try {
        console.log('Starting MFA check...');
        toggleUI("loading");
        
        // Add timeout to prevent infinite loading
        const timeout = setTimeout(() => {
          console.error('MFA check timed out');
          toggleUI("auth");
          alert("‚ùå Login timed out. Please try again.");
        }, 10000); // 10 second timeout

        try {
          const { data: mfa, error } = await supabase.auth.mfa.listFactors();
          clearTimeout(timeout);
          
          console.log('MFA factors:', mfa);
          
          if (error) {
            console.error('MFA list factors error:', error);
            // If we get an error listing factors, assume no MFA is set up
            await tryEnrollMFA();
            return;
          }

          // Check for any existing factors
          const verifiedFactor = mfa?.totp?.find(f => f.status === 'verified');
          const unverifiedFactor = mfa?.totp?.find(f => f.status === 'unverified');
          
          console.log('Verified factor:', verifiedFactor);
          console.log('Unverified factor:', unverifiedFactor);
          
          if (verifiedFactor) {
            console.log('Found verified factor, going to welcome screen');
            toggleUI("welcome");
            return;
          } else if (unverifiedFactor) {
            console.log('Found unverified factor, starting challenge');
            mfaFactorId = unverifiedFactor.id;
            try {
              const { data: challengeData, error: challengeError } = await supabase.auth.mfa.challenge({
                factorId: mfaFactorId
              });
              
              if (challengeError) {
                console.error('MFA challenge error:', challengeError);
                // If challenge fails, try to enroll instead
                await tryEnrollMFA();
                return;
              }
              
              if (challengeData?.totp?.qr_code) {
                console.log('Got QR code, showing setup screen');
                document.getElementById("mfa-qr").src = challengeData.totp.qr_code;
                toggleUI("mfa-setup");
                return;
              }
            } catch (err) {
              console.error('MFA challenge exception:', err);
              // If challenge fails, try to enroll instead
              await tryEnrollMFA();
              return;
            }
          } else {
            console.log('No factors found, attempting enrollment');
            await tryEnrollMFA();
          }
        } catch (err) {
          console.error('MFA list factors exception:', err);
          clearTimeout(timeout);
          // If we can't list factors, try to enroll
          await tryEnrollMFA();
        }
      } catch (err) {
        console.error('MFA handle error:', err);
        toggleUI("auth");
        return alert("‚ùå Failed to handle MFA. Please try logging in again.");
      }
    }

    async function tryEnrollMFA(retry = false) {
      try {
        console.log('Starting MFA enrollment...');
        toggleUI("loading");
        
        // Double check that we don't have any factors before enrolling
        const { data: factors, error: listError } = await supabase.auth.mfa.listFactors();
        
        if (listError) {
          console.error('MFA list factors error during enrollment:', listError);
          if (!retry) {
            return tryEnrollMFA(true);
          }
          toggleUI("auth");
          return alert("‚ùå Failed to check existing MFA factors. Please try logging in again.");
        }

        // If we have any factors at all, don't try to enroll
        if (factors?.totp?.length > 0) {
          console.log('Found existing factors, attempting to use them');
          const unverifiedFactor = factors.totp.find(f => f.status === 'unverified');
          if (unverifiedFactor) {
            mfaFactorId = unverifiedFactor.id;
            const { data: challengeData } = await supabase.auth.mfa.challenge({
              factorId: mfaFactorId
            });
            if (challengeData?.totp?.qr_code) {
              document.getElementById("mfa-qr").src = challengeData.totp.qr_code;
              toggleUI("mfa-setup");
              return;
            }
          }
          toggleUI("auth");
          return alert("‚ùå MFA is already set up for this account. Please log in again.");
        }

        // Only proceed with enrollment if we have no factors
        console.log('No existing factors, creating new one');
        const { data: enrollData, error: enrollError } = await supabase.auth.mfa.enroll({
          factorType: 'totp',
          friendlyName: 'Authenticator App'
        });

        if (enrollError) {
          console.error('MFA enrollment error:', enrollError);
          if (!retry) {
            return tryEnrollMFA(true);
          }
          toggleUI("auth");
          return alert("‚ùå MFA enrollment failed: " + enrollError.message);
        }

        if (!enrollData?.totp?.qr_code) {
          console.error('Missing QR code in enrollment data:', enrollData);
          if (!retry) {
            return tryEnrollMFA(true);
          }
          toggleUI("auth");
          return alert("‚ùå MFA QR code generation failed. Please try logging in again.");
        }

        mfaFactorId = enrollData.id;
        document.getElementById("mfa-qr").src = enrollData.totp.qr_code;
        toggleUI("mfa-setup");
      } catch (err) {
        console.error('MFA enrollment exception:', err);
        if (!retry) {
          return tryEnrollMFA(true);
        }
        toggleUI("auth");
        return alert("‚ùå MFA enrollment failed. Please try logging in again.");
      }
    }

    function toggleUI(section) {
      const all = ["auth", "mfa-setup", "loading", "welcome", "logout"];
      all.forEach(id => {
        document.getElementById(id).style.display = (id === section || (section === "welcome" && id === "logout")) ? "block" : "none";
      });
    }

    // Initialize
    toggleUI("auth");
    
    // Check for force logout parameter
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('logout') === 'true') {
      supabase.auth.signOut();
      // Remove the logout parameter from URL without refreshing
      window.history.replaceState({}, document.title, window.location.pathname);
    }
    
    handleAuthRedirect();

    // Listen for auth state changes
    supabase.auth.onAuthStateChange(async (event, session) => {
      console.log('Auth state changed:', event, session);
      if (event === 'SIGNED_IN') {
        document.getElementById("user-email").innerText = session.user.email;
        await handleMFA();
      } else if (event === 'SIGNED_OUT') {
        toggleUI("auth");
      }
    });
  </script>
</body>
</html>
